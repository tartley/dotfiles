#!/usr/bin/env bash

# See usage() below.

set -e # exit on error
set -u # treat unset vars as errors
# set -x # debugging output
set -o pipefail

usage() {
    echo "Copy a fixed set of $HOME dotfiles (eg. .bashrc), into the given LXD containers."
    echo "The intent is to make the container ready for use as a development environment."
    echo "Usage: One of:"
    echo "    lxc-setup <container>..."
    echo "    lxc-setup --all|-a"
    echo "    lxc-setup --help|-h"
    echo "Where options are:"
    echo "    -a|--all      Act on all existing lxd containers."
    echo "    -h|--help     Show this help and exit."
}

process_cmdline() {
    all=false
    containers=()
    while [ $# -gt 0 ] ; do
        case "$1" in
            -h|--help) usage; exit;;
            -a|--all) all=true;;
            *) containers+=("$1");;
        esac
        shift
    done

    if [ ${#containers[@]} -ne 0 ] && "$all" ; then
        echo "lxc-setup: ERROR: Containers and '--all' are mutually exclusive." >&2
        usage >&2
        exit 1
    fi

    if $all ; then
        IFS=$'\n' containers=($(lxcls))
    else
        if [ "${#containers[@]}" -eq 0 ] ; then
            echo "lxc-setup: WARNING: No containers specified." >&2
            usage >&2
            exit 1
        fi
    fi
}

validate_container() {
    # Validate that the given container name is a real existing container
    local container="$1"
    if ! grep -q "^$container$" <<<"$(lxcls)" ; then
        echo "Not a valid container name" >&2
        return 1
    fi
}

copy_dotfiles() {
    local container="$1"
    echo -n "copying... "
    scp -qrp \
        ~/.bashrc* \
        ~/.bazaar/ \
        ~/.config/bat/config \
        ~/.dircolors \
        ~/.git-completion.bash \
        ~/.gitconfig \
        ~/.gitconfig.private \
        ~/.profile \
        ~/.ps1_vcs \
        ~/.pythonstartup.py \
        $container.lxd:~
}

configure_container() {
    local container="$1"
    copy_dotfiles "$container"
}

is_running() {
    local container="$1"
    if lxc info $container | grep -q 'Status: RUNNING' ; then
        echo true
    else
        echo false
    fi
}

wait_for_container() {
    # Wait for a (presumably new) container to start responding to ssh.
    # Without this, subsequent scp attempts would sometimes fail with 'lost connection'.
    # TODO: Add a timeout?
    local container="$1"
    while ! ssh -q -o ConnectTimeout=1 "$container.lxd" -- : ; do
        echo -n "." >&2
    done
}

start_container() {
    # If the given container isn't already running, start it up
    local container="$1"
    was_initially_running=$(is_running "$container")
    if [ "$was_initially_running" = false ] ; then
        echo -n "starting.." >&2
        lxc start "$container"
        wait_for_container "$container"
        echo -n " " >&2
    fi
    echo "$was_initially_running" # true or false
}

stop_container() {
    # If we started the container, now we stop it again,
    # to leave things how we found them.
    local container="$1"
    local was_initially_running="$2"
    if [ "$was_initially_running" = false ] ; then
        echo -n "stopping... " >&2
        lxc stop "$container" &
    fi
}

process_container() {
    local container="$1"
    echo -n "$container: " >&2
    if ! validate_container "$container"; then
        return 1
    fi
    was_initially_running=$(start_container "$container")
    configure_container "$container"
    stop_container "$container" "$was_initially_running"
    echo "ok" >&2
}

process_cmdline "$@"
exitval=0
for container in ${containers[@]}; do
    process_container "$container" || exitval=1
done
exit $exitval

