#!/usr/bin/env bash

set -e # exit on error
# set -x # debugging output
set -u # exist on unset variables

if [ "$#" -ne 1 ] ; then
    echo "Usage: lssh <projectname>"
    return
fi
alias="$1"
container=$(lalias $alias)
host="$container.lxd"

destdir="$HOME"
if [ -d "$HOME/src/$alias" ]; then
    destdir="$HOME/src/$alias"
fi

tname="$container"
if [ "$alias" != "$container" ]; then
    tname="$alias on $container"
fi

termname "$tname"

# ssh to container.
# Requires containers to have IPv4 address,
# and name resolution to be working.
# -A: Forward ssh-agent. So we can, for example,
#     hit github using passphrases cached by ssh-agent.
# -t: Force pseudo-terminal allocation. (I forget why.)
ssh -A -t "${host}" -- "cd $destdir; exec -l $SHELL"

termname "Terminal"

